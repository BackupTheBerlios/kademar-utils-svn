#!/bin/bash

# Script per Regenerar les llibreries del WINE, per tal de que
# utilitzi llibreries que acaba d'instal·lar, com les VBrun, etc

# Creat per Adonay Sanz Alsina - 13-setembre-2006
# Llicenciat sota GNU/GPL 2
# kademar GNU/Linux

# set -x
wine="$HOME/.wine/user.reg"

#Si no existeix el fitxer, surt
[ ! -e "$wine" ] && echo "Need to execute Wine first" && exit 1

#Fes un print del fitxer amb el que estas treballant
echo $wine
#Refés les Llibreries
refer_libs(){
#Mira quines DLLS estan disponibles
for i in `ls $HOME/.wine/drive_c/windows/system32 | grep -i .dll | tr A-Z a-z | sed s/.dll//g`
do
	#Posa la DLL en format wine  user.reg
	linia_a_escriure='"'$i'"'='"'native,builtin'"'
	#Si la linia no existeix (per no sobreemplenar el fitxer), escriu-la, sino, passa de tot
	[ -z "`grep "$linia_a_escriure" $wine `" ] && echo $linia_a_escriure >> "$wine$1"
done
}

#Mira si existeix la linia de DLLS, per afegir-ho tot sense mirar, o per controlar el que fa
found=`cat "$wine" | grep Software | egrep Wine | egrep DllOverrides`


if [ -z "$found" ]; then
#Si no ho ha trobat, a final del fitxer, existeix
	echo >> "$wine"
	echo >> "$wine"
	echo '[Software\\Wine\\DllOverrides] 1148837818' >> "$wine$1"
	refer_libs
else
#Si ho ha trobat, vol dir que hem d'anar en cura del que farem
	#Desactivem aquesta variable, pq encara no hem trobat la linia que volem 
	noferres=desactivat
	#Borrem temporals
	rm -f $wine.tmp
	#Processem el fitxer
	cat "$wine" | while read line
	do
		#Si està desactivada, no hem trobat la linia, per tan hem de continuar buscant
		if [ "$noferres" != "actiu" ]; then
			#Mirem si la linia en la que està, és la portadora de les DLLs
			comprovant=`echo "$line" | grep Software | egrep Wine | egrep DllOverrides`
# 			echo $comprovant
			#Si no és portadora, passa d'ella. Escriu-la i continúa processant
			#Si és la que volem
			if [ -n "$comprovant" ]; then
				#Escriu la linia "[Software\\Wine\\DllOverrides]" que estèm
				echo "$line" >> $wine.tmp
				#I refés les llibreries, en un fitxer temporal
				refer_libs ".tmp"
				#Activa la variable noferres, perquè ja hem trobat el que necessitàvem, i no ens interessa rès més
				noferres=actiu
			else
				#Si no és portadora, passa d'ella. Escriu-la i continúa processant
				echo "$line" >> $wine.tmp
			fi
		else
			#Si la variable "noferres" està activa, vol dir que hem trobat i ja hem fet el que voliem, per tant no ens interessa res més
			echo "$line" >> $wine.tmp
		fi
	done
	#borrem el normal i el substituïm pel temporal
 	rm -f "$wine"
 	mv "$wine.tmp" "$wine"
fi

#Wine EXAMPLE
# [Software\\Wine\\DllOverrides] 1148837818
# "advapi32"="native,builtin"

