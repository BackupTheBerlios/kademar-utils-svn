#!/bin/bash 
# TODO poder escollir l'arquitectura

#Elric Milon
#Adonay Sanz

###Carrego variables de config
. /usr/lib/kademar-scripts/sourcables/load_config 

if [ -e "/$BURNIX_ROOT/bin/bash" -a ! -d "$BURNIX_ROOT/debootstrap" ]; then

	echo "The filesystem has been already created"
	sleep 3

	else 

		if [ -z "$DEB_MIRROR" ]; then
			DEB_MIRROR="http://ftp.debian.org/"
		else
			tip "Mirror defined in profile"
		fi

		tip "Using mirror:" $DEB_MIRROR

		
		if [ -z "$ARCH" ]; then
			ARCH="i386"
		else
			tip "Arch defined in profile"
		fi

		tip "Using architecture:" $ARCH

		if [ -z "$DIST" ]; then
			DIST="testing"
		else
			tip "Dist defined in profile"
		fi
		
		tip "Using distribution:" $DIST
		
		if [ ! -z "$APT_CACHER_URL" ] ; then
			MIRROR=`echo $DEB_MIRROR | sed "s,http://,&$APT_CACHER_URL:3142/,"`
		else
			MIRROR=$DEB_MIRROR
		fi
		
		tip "Creating Live-CD filesystem"
		debootstrap --verbose --arch "$ARCH" "$DIST" "$BURNIX_ROOT" "$MIRROR"
		iferrorexit "debootstraping, exiting"
		
		if [ ! -z "$PACKAGES" ]; then
			tip "Installing packages specified in profile"

			if [ "USE_SOURCES_FROM_HOST" != yes ] ; then
				echo  deb $DEB_MIRROR $DIST main contrib non-free >> $BURNIX_ROOT/etc/apt/sources.list
			fi

			# Execute pre_chroot commands to prepare debootstraped system
			. /usr/lib/kademar-scripts/sourcables/pre_chroot

			#Update apt-get file databases
			su - root -c "chroot $BURNIX_ROOT /usr/bin/apt-get update"
			#Correct possible dependences on debootstraped system
			su - root -c "chroot $BURNIX_ROOT /usr/bin/apt-get -fy install"
			#Install profile specified packages
			su - root -c "chroot $BURNIX_ROOT /usr/bin/apt-get -y install ` echo $PACKAGES | sed  's-\n- -g' `"
			
			ask "Do you want to install the autogenerated kernel and modules into the recently debootstraped system?"
			if [ "$ANSWER" = "y" ]; then
				tip "Installing every package in common/kernel dir"
				su - root -c "chroot $BURNIX_ROOT /usr/bin/dpkg -i /common/kernel/*.deb" 
				su - root -c "chroot $BURNIX_ROOT /usr/bin/apt-get -fy install"
			fi
										 
			
			# clean /var/cache/apt/archives of base system, it is unecessarilly because un post_chroot it umount this folder
# 			su - root -c "chroot $BURNIX_ROOT /usr/bin/apt-get clean"
			
			#Execute post_chroot commands to leave debootstraped system 
			. /usr/lib/kademar-scripts/sourcables/post_chroot
			
			error_debootstrap=no
			
			if [ $? != 0 ]; then
				error "Installing packages, please check for error messages upwards."
				error_debootstrap=yes
				exit 1
			else
				ok "Debootstrap Done"
			fi
			
			echo ; echo
			ask "Do you want me to compile a specific kernel for this profile?"
			if [ "$ANSWER" = "y" ]; then 
				/usr/lib/kademar-scripts/build-kernel $*
			fi
		fi
		
		clear
		
		[ "$error_debootstrap" = "yes" ] && error "You must re-run kademar-dev, in order to build your debootstraped system"
		
fi
# Delete lock file, to run menu without problems after
rm -f "$DEVEL_ROOT/lock"
